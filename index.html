<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="SecureVault - å®‰å…¨çš„å€‹äººè²¡å‹™ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´è¨˜å¸³ã€å¯†ç¢¼ç®¡ç†å’Œè³‡ç”¢è¿½è¹¤ï¼Œæ¡ç”¨AES-256åŠ å¯†ä¿è­·æ‚¨çš„æ•¸æ“š">
    <meta name="keywords" content="è¨˜å¸³,å¯†ç¢¼ç®¡ç†,è³‡ç”¢ç®¡ç†,åŠ å¯†,è²¡å‹™ç®¡ç†,å€‹äººç†è²¡">
    <meta name="author" content="SecureVault">
    <meta name="theme-color" content="#00d4aa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureVault">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
    <title>SecureVault - å€‹äººè²¡å‹™ç®¡ç†ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141829;
            --bg-card: #1a1f3a;
            --accent-primary: #00d4aa;
            --accent-secondary: #0099ff;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #2d3548;
            --success: #00d4aa;
            --warning: #ffb800;
            --danger: #ff4757;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ç™»å…¥ç•«é¢ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        }
        
        .login-box {
            background: var(--bg-card);
            padding: 50px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 212, 170, 0.1);
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .error-message {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        /* ä¸»æ‡‰ç”¨ä»‹é¢ */
        .app-screen {
            display: none;
        }
        
        .header {
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(0, 212, 170, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--accent-primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .btn-add {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 170, 0.3);
        }
        
        .data-list {
            margin-top: 20px;
        }
        
        .data-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .data-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }
        
        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .data-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .data-item-amount {
            font-size: 20px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .amount-positive {
            color: var(--success);
        }
        
        .amount-negative {
            color: var(--danger);
        }
        
        .data-item-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .info-label {
            color: var(--text-secondary);
        }
        
        .info-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .btn-delete {
            padding: 8px 15px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            border-radius: 6px;
            color: var(--danger);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            user-select: none;
        }
        
        .password-field {
            position: relative;
        }
        
        .password-value {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .summary-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .category-breakdown {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }
        
        .category-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .category-amount {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 16px;
        }
        
        .category-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .category-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.5s ease;
        }
        
        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--danger);
            border-color: var(--danger);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        @media (max-width: 768px) {
            .login-box {
                padding: 30px;
            }
            
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .header-actions .btn-secondary {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                max-height: 95vh;
                border-radius: 15px;
            }
            
            .modal-header,
            .modal-body {
                padding: 20px;
            }
        }
    
/* ===== Startup Animation PRO ===== */
:root{--sv-bg:#0a0e27;--sv-accent:#00d4aa;}
#startup{position:fixed;inset:0;background:var(--sv-bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#startup .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;animation:svFadeScale 900ms cubic-bezier(.2,.8,.2,1) forwards}
#startup .logo{width:88px;height:88px;filter:drop-shadow(0 0 0 rgba(0,212,170,.0));animation:svBreath 2.2s ease-in-out infinite}
#startup .title{color:var(--sv-accent);font-weight:600}
#startup .sub{color:#9aa0a6;font-size:12px}
@keyframes svFadeScale{0%{opacity:0;transform:scale(.96)}60%{opacity:1;transform:scale(1)}100%{opacity:1;transform:scale(1)}}
@keyframes svBreath{0%{filter:drop-shadow(0 0 0 rgba(0,212,170,.0))}50%{filter:drop-shadow(0 0 14px rgba(0,212,170,.45))}100%{filter:drop-shadow(0 0 0 rgba(0,212,170,.0))}}
@keyframes svExit{to{opacity:0;visibility:hidden}}

</style>

<link rel="apple-touch-startup-image" href="splash-iphone-se.png" media="(device-width: 320px) and (device-height: 568px)">
<link rel="apple-touch-startup-image" href="splash-iphone-8.png" media="(device-width: 375px) and (device-height: 667px)">
<link rel="apple-touch-startup-image" href="splash-iphone-8-plus.png" media="(device-width: 414px) and (device-height: 736px)">
<link rel="apple-touch-startup-image" href="splash-iphone-x.png" media="(device-width: 375px) and (device-height: 812px)">
<link rel="apple-touch-startup-image" href="splash-iphone-11-pro-max.png" media="(device-width: 414px) and (device-height: 896px)">
<link rel="apple-touch-startup-image" href="splash-iphone-14-pro-max.png" media="(device-width: 430px) and (device-height: 932px)">
<link rel="apple-touch-startup-image" href="splash-ipad.png" media="(device-width: 768px) and (device-height: 1024px)">
<link rel="apple-touch-startup-image" href="splash-ipad-pro-12-9.png" media="(device-width: 1024px) and (device-height: 1366px)">

</head>
<body>

<div id="startup">
  <div class="wrap">
    <img class="logo" src="logo.svg" alt="SecureVault"/>
    <div class="title">SecureVault</div>
    <div class="sub">Enterprise Secure Finance Vault</div>
  </div>
</div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">
                <h1>ğŸ” SecureVault</h1>
                <p>åŠ å¯†çš„å€‹äººè²¡å‹™ç®¡ç†ç³»çµ±</p>
            </div>
            <div id="loginError" class="error-message"></div>
            <div class="input-group">
                <label for="masterPassword">ä¸»å¯†ç¢¼</label>
                <input type="password" id="masterPassword" placeholder="è¼¸å…¥æ‚¨çš„ä¸»å¯†ç¢¼" autocomplete="off">
            </div>
            <button class="btn" onclick="login()">è§£é–</button>
            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 212, 170, 0.1); border-radius: 8px; border: 1px solid rgba(0, 212, 170, 0.3);">
                <p style="text-align: center; color: var(--text-secondary); font-size: 12px; line-height: 1.6;">
                    <strong style="color: var(--accent-primary);">ğŸ”’ å®‰å…¨æç¤º</strong><br>
                    â€¢ é¦–æ¬¡ä½¿ç”¨è«‹è¨­å®šä¸»å¯†ç¢¼<br>
                    â€¢ æ‰€æœ‰æ•¸æ“šä½¿ç”¨ AES-256 åŠ å¯†<br>
                    â€¢ æ•¸æ“šåƒ…å­˜å„²åœ¨æ‚¨çš„è£ç½®ä¸Š<br>
                    â€¢ è«‹å¦¥å–„ä¿ç®¡ä¸»å¯†ç¢¼ï¼Œéºå¤±ç„¡æ³•æ‰¾å›
                </p>
            </div>
            <p style="margin-top: 15px; text-align: center; color: var(--text-secondary); font-size: 11px;">
                Version 1.0.0 | Made with â¤ï¸
            </p>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ä»‹é¢ -->
    <div class="app-screen" id="appScreen">
        <div class="container">
            <div class="header">
                <h2>SecureVault</h2>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="importData()">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button>
                    <button class="btn-secondary" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</button>
                    <button class="btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ•¸æ“š</button>
                    <button class="btn-secondary" onclick="logout()">ğŸšª ç™»å‡º</button>
                </div>
            </div>

            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">

            <div class="tabs">
                <button class="tab active" onclick="switchTab(0)">ğŸ“Š è¨˜å¸³</button>
                <button class="tab" onclick="switchTab(1)">ğŸ”‘ å¯†ç¢¼ç®¡ç†</button>
                <button class="tab" onclick="switchTab(2)">ğŸ’ è³‡ç”¢ç®¡ç†</button>
            </div>

            <!-- è¨˜å¸³åŠŸèƒ½ -->
            <div class="tab-content active" id="tab0">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æ”¶å…¥</div>
                        <div class="summary-value" id="totalIncome">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æ”¯å‡º</div>
                        <div class="summary-value" id="totalExpense" style="color: var(--danger);">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">æ·¨é¤˜é¡</div>
                        <div class="summary-value" id="netBalance">$0</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">æ–°å¢è¨˜å¸³è¨˜éŒ„</h3>
                        <button class="btn-secondary" onclick="showMonthlyReport()" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none;">
                            ğŸ“… æŸ¥çœ‹æœˆåº¦çµç®—
                        </button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é¡å‹</label>
                            <select id="transactionType" onchange="updateCategoryOptions()">
                                <option value="expense">æ”¯å‡º</option>
                                <option value="income">æ”¶å…¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡åˆ¥</label>
                            <select id="transactionCategory" onchange="handleCategoryChange()">
                                <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                            </select>
                            <input type="text" id="customCategory" placeholder="è¼¸å…¥è‡ªè¨‚é¡åˆ¥" style="display: none; margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label>é‡‘é¡ (NT$)</label>
                            <input type="number" id="transactionAmount" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>æ—¥æœŸ</label>
                            <input type="date" id="transactionDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="transactionNote" placeholder="é¸å¡«"></textarea>
                    </div>
                    <button class="btn-add" onclick="addTransaction()">â• æ–°å¢è¨˜éŒ„</button>
                </div>

                <div class="card">
                    <h3>è¨˜å¸³è¨˜éŒ„</h3>
                    <div class="data-list" id="transactionList"></div>
                </div>
            </div>

            <!-- å¯†ç¢¼ç®¡ç†åŠŸèƒ½ -->
            <div class="tab-content" id="tab1">
                <div class="card">
                    <h3>æ–°å¢å¯†ç¢¼</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¶²ç«™/æ‡‰ç”¨åç¨±</label>
                            <input type="text" id="passwordTitle" placeholder="ä¾‹å¦‚ï¼šGmail">
                        </div>
                        <div class="form-group">
                            <label>å¸³è™Ÿ/Email</label>
                            <input type="text" id="passwordUsername" placeholder="your@email.com">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¯†ç¢¼</label>
                            <input type="password" id="passwordValue" placeholder="è¼¸å…¥å¯†ç¢¼">
                        </div>
                        <div class="form-group">
                            <label>ç¶²å€</label>
                            <input type="text" id="passwordUrl" placeholder="https://example.com (é¸å¡«)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="passwordNote" placeholder="é¸å¡«"></textarea>
                    </div>
                    <button class="btn-add" onclick="addPassword()">â• æ–°å¢å¯†ç¢¼</button>
                </div>

                <div class="card">
                    <h3>å·²å„²å­˜çš„å¯†ç¢¼</h3>
                    <div class="data-list" id="passwordList"></div>
                </div>
            </div>

            <!-- è³‡ç”¢ç®¡ç†åŠŸèƒ½ -->
            <div class="tab-content" id="tab2">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">ç¸½è³‡ç”¢åƒ¹å€¼</div>
                        <div class="summary-value" id="totalStockValue">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æŠ•è³‡æˆæœ¬</div>
                        <div class="summary-value" id="totalStockCost">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æç›Š</div>
                        <div class="summary-value" id="totalStockProfit">$0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>æ–°å¢è³‡ç”¢æŒæœ‰</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è³‡ç”¢é¡å‹</label>
                            <select id="stockSymbol">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="stock">è‚¡ç¥¨</option>
                                <option value="fund">åŸºé‡‘</option>
                                <option value="crypto">åŠ å¯†è²¨å¹£</option>
                                <option value="bond">å‚µåˆ¸</option>
                                <option value="insurance">ä¿éšª</option>
                                <option value="real-estate">ä¸å‹•ç”¢</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è³‡ç”¢åç¨±/ä»£è™Ÿ</label>
                            <input type="text" id="stockName" placeholder="ä¾‹å¦‚ï¼šå°ç©é›» 2330">
                        </div>
                        <div class="form-group">
                            <label>æ‰€æœ‰äºº</label>
                            <input type="text" id="stockOwner" placeholder="ä¾‹å¦‚ï¼šå¼µä¸‰">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æŒæœ‰æ•¸é‡/é‡‘é¡ (é¸å¡«)</label>
                            <input type="number" id="stockShares" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>ç›®å‰åƒ¹å€¼ (NT$)</label>
                            <input type="number" id="stockCurrentPrice" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>è³¼è²·/é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="stockDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="stockNote" placeholder="é¸å¡«"></textarea>
                    </div>
                    <button class="btn-add" onclick="addStock()">â• æ–°å¢è³‡ç”¢</button>
                </div>

                <div class="card">
                    <h3>è³‡ç”¢è¨˜éŒ„</h3>
                    <div class="data-list" id="stockList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœˆåº¦çµç®—æ¨¡æ…‹è¦–çª— -->
    <div class="modal-overlay" id="monthlyReportModal" onclick="closeMonthlyReport(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸ“… æœˆåº¦çµç®—å ±å‘Š</h2>
                <button class="modal-close" onclick="closeMonthlyReport()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 25px;">
                    <label>é¸æ“‡æœˆä»½</label>
                    <input type="month" id="modalMonthPicker" onchange="updateMonthlyReport()">
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">æœ¬æœˆæ”¶å…¥</div>
                        <div class="summary-value" style="font-size: 24px;" id="modalMonthlyIncome">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">æœ¬æœˆæ”¯å‡º</div>
                        <div class="summary-value" style="font-size: 24px; color: var(--danger);" id="modalMonthlyExpense">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">æœ¬æœˆçµé¤˜</div>
                        <div class="summary-value" style="font-size: 24px;" id="modalMonthlyBalance">$0</div>
                    </div>
                </div>

                <div id="modalMonthlyCategoryBreakdown" style="margin-top: 25px;"></div>
                
                <!-- åœ“é¤…åœ– -->
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">ğŸ“Š æ”¯å‡ºåˆ†å¸ƒåœ“é¤…åœ–</h4>
                    <canvas id="modalExpensePieChart" style="max-width: 500px; margin: 0 auto; display: block;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let masterKey = '';
        let appData = {
            transactions: [],
            passwords: [],
            stocks: []
        };
        let pieChartInstance = null;

        // é¡åˆ¥é¸é …å®šç¾©
        const categoryOptions = {
            expense: [
                { value: 'é¤é£²', label: 'ğŸ´ é¤é£²' },
                { value: 'äº¤é€š', label: 'ğŸš— äº¤é€š' },
                { value: 'è³¼ç‰©', label: 'ğŸ›ï¸ è³¼ç‰©' },
                { value: 'å¨›æ¨‚', label: 'ğŸ® å¨›æ¨‚' },
                { value: 'é†«ç™‚', label: 'ğŸ’Š é†«ç™‚' },
                { value: 'æ•™è‚²', label: 'ğŸ“š æ•™è‚²' },
                { value: 'å±…å®¶', label: 'ğŸ  å±…å®¶' },
                { value: 'æ°´é›»è²»', label: 'ğŸ’¡ æ°´é›»è²»' },
                { value: 'é€šè¨Šè²»', label: 'ğŸ“± é€šè¨Šè²»' },
                { value: 'å…¶ä»–æ”¯å‡º', label: 'ğŸ’¸ å…¶ä»–æ”¯å‡º' }
            ],
            income: [
                { value: 'è–ªè³‡', label: 'ğŸ’¼ è–ªè³‡' },
                { value: 'æŠ•è³‡æ”¶ç›Š', label: 'ğŸ’° æŠ•è³‡æ”¶ç›Š' },
                { value: 'çé‡‘', label: 'ğŸ çé‡‘' },
                { value: 'è‚¡ç¥¨', label: 'ğŸ“ˆ è‚¡ç¥¨' },
                { value: 'åŸºé‡‘', label: 'ğŸ“Š åŸºé‡‘' },
                { value: 'åŠ å¯†è²¨å¹£', label: 'ğŸª™ åŠ å¯†è²¨å¹£' },
                { value: 'å‚µåˆ¸', label: 'ğŸ“œ å‚µåˆ¸' },
                { value: 'ä¿éšª', label: 'ğŸ›¡ï¸ ä¿éšª' },
                { value: 'ä¸å‹•ç”¢', label: 'ğŸ¢ ä¸å‹•ç”¢' },
                { value: 'å…¶ä»–æ”¶å…¥', label: 'ğŸ’µ å…¶ä»–æ”¶å…¥' }
            ]
        };

        // æ ¹æ“šé¡å‹æ›´æ–°é¡åˆ¥é¸é …
        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            const customInput = document.getElementById('customCategory');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡é¡åˆ¥</option>';
            
            // æ·»åŠ å°æ‡‰çš„é¡åˆ¥é¸é …
            const options = categoryOptions[type] || [];
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                categorySelect.appendChild(option);
            });
            
            // æ·»åŠ è‡ªè¨‚é¸é …
            const customOption = document.createElement('option');
            customOption.value = 'è‡ªè¨‚';
            customOption.textContent = 'âœï¸ è‡ªè¨‚é¡åˆ¥...';
            categorySelect.appendChild(customOption);
            
            // éš±è—è‡ªè¨‚è¼¸å…¥æ¡†
            customInput.style.display = 'none';
            customInput.value = '';
        }

        // è™•ç†é¡åˆ¥é¸æ“‡
        function handleCategoryChange() {
            const categorySelect = document.getElementById('transactionCategory');
            const customInput = document.getElementById('customCategory');
            
            if (categorySelect.value === 'è‡ªè¨‚') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        // åŠ å¯†å‡½æ•¸
        function encrypt(data, key) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        }

        // è§£å¯†å‡½æ•¸
        function decrypt(encryptedData, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, key);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                return null;
            }
        }

        // å„²å­˜æ•¸æ“šåˆ° localStorage
        function saveData() {
            const encrypted = encrypt(appData, masterKey);
            localStorage.setItem('secureVaultData', encrypted);
        }

        // è¼‰å…¥æ•¸æ“šå¾ localStorage
        function loadData() {
            const encrypted = localStorage.getItem('secureVaultData');
            if (encrypted) {
                const decrypted = decrypt(encrypted, masterKey);
                if (decrypted) {
                    appData = decrypted;
                    return true;
                }
                return false;
            }
            return true; // é¦–æ¬¡ä½¿ç”¨
        }

        // ç™»å…¥
        function login() {
            const password = document.getElementById('masterPassword').value;
            if (!password) {
                showError('è«‹è¼¸å…¥ä¸»å¯†ç¢¼');
                return;
            }

            // é¦–æ¬¡ä½¿ç”¨æ™‚çš„å¯†ç¢¼å¼·åº¦æª¢æŸ¥
            const existingData = localStorage.getItem('secureVaultData');
            if (!existingData && password.length < 6) {
                showError('ä¸»å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒï¼Œå»ºè­°ä½¿ç”¨æ›´å¼·çš„å¯†ç¢¼ï¼');
                return;
            }

            masterKey = password;
            
            if (!loadData()) {
                showError('å¯†ç¢¼éŒ¯èª¤ï¼');
                masterKey = '';
                return;
            }

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('masterPassword').value = '';
            
            renderAll();
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚')) {
                masterKey = '';
                appData = { transactions: [], passwords: [], stocks: [] };
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // åˆ‡æ›åˆ†é 
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
        }

        // è¨˜å¸³åŠŸèƒ½
        function addTransaction() {
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            let category = document.getElementById('transactionCategory').value;
            const date = document.getElementById('transactionDate').value;
            const note = document.getElementById('transactionNote').value;

            // å¦‚æœé¸æ“‡è‡ªè¨‚é¡åˆ¥ï¼Œä½¿ç”¨è‡ªè¨‚è¼¸å…¥çš„å€¼
            if (category === 'è‡ªè¨‚') {
                const customCategory = document.getElementById('customCategory').value.trim();
                if (!customCategory) {
                    alert('è«‹è¼¸å…¥è‡ªè¨‚é¡åˆ¥åç¨±ï¼');
                    return;
                }
                category = customCategory;
            }

            if (!amount || amount <= 0 || !category || !date) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            appData.transactions.push({
                id: Date.now(),
                type,
                amount,
                category,
                date,
                note
            });

            // å¦‚æœé¡åˆ¥æ˜¯è³‡ç”¢é¡å‹ï¼Œè‡ªå‹•åŒæ­¥åˆ°è³‡ç”¢ç®¡ç†
            const assetCategories = ['è‚¡ç¥¨', 'åŸºé‡‘', 'åŠ å¯†è²¨å¹£', 'å‚µåˆ¸', 'ä¿éšª', 'ä¸å‹•ç”¢'];
            if (type === 'income' && assetCategories.includes(category)) {
                syncToAssetManagement(category, amount, date, note);
            }

            saveData();
            renderTransactions();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionCategory').value = '';
            document.getElementById('customCategory').value = '';
            document.getElementById('customCategory').style.display = 'none';
            document.getElementById('transactionNote').value = '';
        }

        // åŒæ­¥è¨˜å¸³åˆ°è³‡ç”¢ç®¡ç†
        function syncToAssetManagement(category, amount, date, note) {
            const assetTypeMap = {
                'è‚¡ç¥¨': 'stock',
                'åŸºé‡‘': 'fund',
                'åŠ å¯†è²¨å¹£': 'crypto',
                'å‚µåˆ¸': 'bond',
                'ä¿éšª': 'insurance',
                'ä¸å‹•ç”¢': 'real-estate'
            };

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒé¡åˆ¥çš„è³‡ç”¢
            const existingAsset = appData.stocks.find(s => s.assetType === category);
            
            if (existingAsset) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°å…¶åƒ¹å€¼
                existingAsset.currentPrice = parseFloat(existingAsset.currentPrice) + amount;
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°è³‡ç”¢
                appData.stocks.push({
                    id: Date.now(),
                    symbol: assetTypeMap[category],
                    assetType: category,
                    name: `${category}æŠ•è³‡`,
                    owner: 'æˆ‘',
                    shares: 0,
                    currentPrice: amount,
                    date: date,
                    note: note || `è‡ªå‹•å¾è¨˜å¸³åŒæ­¥ - ${category}`
                });
            }

            renderStocks();
        }

        function deleteTransaction(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                appData.transactions = appData.transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
            }
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            
            if (appData.transactions.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>é‚„æ²’æœ‰ä»»ä½•è¨˜å¸³è¨˜éŒ„</p></div>';
                updateTransactionSummary();
                return;
            }

            const sorted = [...appData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(t => `
                <div class="data-item">
                    <div class="data-item-header">
                        <div>
                            <div class="data-item-title">${t.category}</div>
                            <div class="data-item-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                                ${t.type === 'income' ? '+' : '-'}NT$ ${t.amount.toLocaleString('zh-TW')}
                            </div>
                        </div>
                        <button class="btn-delete" onclick="deleteTransaction(${t.id})">åˆªé™¤</button>
                    </div>
                    <div class="data-item-info">
                        <div><span class="info-label">æ—¥æœŸï¼š</span><span class="info-value">${t.date}</span></div>
                        <div><span class="info-label">é¡å‹ï¼š</span><span class="info-value">${t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span></div>
                        ${t.note ? `<div style="grid-column: 1/-1;"><span class="info-label">å‚™è¨»ï¼š</span><span class="info-value">${t.note}</span></div>` : ''}
                    </div>
                </div>
            `).join('');

            updateTransactionSummary();
        }

        function updateTransactionSummary() {
            const income = appData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const net = income - expense;

            document.getElementById('totalIncome').textContent = `NT$ ${income.toLocaleString('zh-TW')}`;
            document.getElementById('totalExpense').textContent = `NT$ ${expense.toLocaleString('zh-TW')}`;
            document.getElementById('netBalance').textContent = `NT$ ${net.toLocaleString('zh-TW')}`;
        }

        // æœˆåº¦çµç®—åŠŸèƒ½
        function updateMonthlyReport() {
            const selectedMonth = document.getElementById('modalMonthPicker').value;
            if (!selectedMonth) return;

            const [year, month] = selectedMonth.split('-');
            
            // ç¯©é¸è©²æœˆä»½çš„äº¤æ˜“
            const monthlyTransactions = appData.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === parseInt(year) && 
                       (tDate.getMonth() + 1) === parseInt(month);
            });

            // è¨ˆç®—æ”¶å…¥å’Œæ”¯å‡º
            const income = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expense;

            // æ›´æ–°æ¨¡æ…‹è¦–çª—ä¸­çš„æœˆåº¦çµ±è¨ˆ
            document.getElementById('modalMonthlyIncome').textContent = `NT$ ${income.toLocaleString('zh-TW')}`;
            document.getElementById('modalMonthlyExpense').textContent = `NT$ ${expense.toLocaleString('zh-TW')}`;
            document.getElementById('modalMonthlyBalance').textContent = `NT$ ${balance.toLocaleString('zh-TW')}`;
            document.getElementById('modalMonthlyBalance').style.color = balance >= 0 ? 'var(--success)' : 'var(--danger)';

            // ç”Ÿæˆåˆ†é¡çµ±è¨ˆ
            generateCategoryBreakdown(monthlyTransactions);
            
            // ç”Ÿæˆåœ“é¤…åœ–
            generatePieChart(monthlyTransactions);
        }

        function generateCategoryBreakdown(transactions) {
            const breakdownDiv = document.getElementById('modalMonthlyCategoryBreakdown');
            
            if (transactions.length === 0) {
                breakdownDiv.innerHTML = '<div class="empty-state"><p style="font-size: 14px; margin: 20px 0;">æœ¬æœˆå°šç„¡äº¤æ˜“è¨˜éŒ„</p></div>';
                return;
            }

            // æŒ‰é¡åˆ¥çµ±è¨ˆæ”¯å‡º
            const expenseByCategory = {};
            const incomeByCategory = {};
            
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
                } else {
                    incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
                }
            });

            const totalExpense = Object.values(expenseByCategory).reduce((sum, val) => sum + val, 0);
            const totalIncome = Object.values(incomeByCategory).reduce((sum, val) => sum + val, 0);

            let html = '';

            // æ”¯å‡ºåˆ†é¡
            if (Object.keys(expenseByCategory).length > 0) {
                html += '<h4 style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">ğŸ’¸ æ”¯å‡ºåˆ†é¡</h4>';
                html += '<div class="category-breakdown">';
                
                Object.entries(expenseByCategory)
                    .sort(([, a], [, b]) => b - a)
                    .forEach(([category, amount]) => {
                        const percentage = ((amount / totalExpense) * 100).toFixed(1);
                        html += `
                            <div class="category-item">
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span class="category-name">${category}</span>
                                        <span class="category-amount" style="color: var(--danger);">NT$ ${amount.toLocaleString('zh-TW')}</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill" style="width: ${percentage}%; background: linear-gradient(135deg, #ff4757, #ff6b81);"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">${percentage}%</div>
                                </div>
                            </div>
                        `;
                    });
                
                html += '</div>';
            }

            // æ”¶å…¥åˆ†é¡
            if (Object.keys(incomeByCategory).length > 0) {
                html += '<h4 style="color: var(--text-secondary); font-size: 14px; margin: 20px 0 10px 0;">ğŸ’° æ”¶å…¥åˆ†é¡</h4>';
                html += '<div class="category-breakdown">';
                
                Object.entries(incomeByCategory)
                    .sort(([, a], [, b]) => b - a)
                    .forEach(([category, amount]) => {
                        const percentage = ((amount / totalIncome) * 100).toFixed(1);
                        html += `
                            <div class="category-item">
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span class="category-name">${category}</span>
                                        <span class="category-amount" style="color: var(--success);">NT$ ${amount.toLocaleString('zh-TW')}</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill" style="width: ${percentage}%;"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">${percentage}%</div>
                                </div>
                            </div>
                        `;
                    });
                
                html += '</div>';
            }

            breakdownDiv.innerHTML = html;
        }

        // ç”Ÿæˆåœ“é¤…åœ–
        function generatePieChart(transactions) {
            const ctx = document.getElementById('modalExpensePieChart');
            
            if (!ctx) return;

            // ç¯©é¸æ”¯å‡ºäº¤æ˜“
            const expenses = transactions.filter(t => t.type === 'expense');
            
            // å¦‚æœæ²’æœ‰æ”¯å‡ºï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
            if (expenses.length === 0) {
                if (pieChartInstance) {
                    pieChartInstance.destroy();
                    pieChartInstance = null;
                }
                ctx.style.display = 'none';
                return;
            }
            
            ctx.style.display = 'block';

            // æŒ‰é¡åˆ¥çµ±è¨ˆ
            const expenseByCategory = {};
            expenses.forEach(t => {
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
            });

            // æº–å‚™åœ–è¡¨è³‡æ–™
            const sortedCategories = Object.entries(expenseByCategory)
                .sort(([, a], [, b]) => b - a);
            
            const labels = sortedCategories.map(([cat]) => cat);
            const data = sortedCategories.map(([, amt]) => amt);
            
            // ç”Ÿæˆæ¼‚äº®çš„é¡è‰²
            const colors = [
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
                '#dfe6e9', '#74b9ff', '#a29bfe', '#fd79a8', '#fdcb6e',
                '#e17055', '#00b894', '#00cec9', '#0984e3', '#6c5ce7'
            ];

            // éŠ·æ¯€èˆŠåœ–è¡¨
            if (pieChartInstance) {
                pieChartInstance.destroy();
            }

            // å‰µå»ºæ–°åœ–è¡¨
            pieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1a1f3a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e8eaed',
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: "'Noto Sans TC', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1f3a',
                            titleColor: '#e8eaed',
                            bodyColor: '#e8eaed',
                            borderColor: '#2d3548',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: NT$ ${value.toLocaleString('zh-TW')} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // é¡¯ç¤ºæœˆåº¦çµç®—å ±å‘Š
        function showMonthlyReport() {
            const modal = document.getElementById('monthlyReportModal');
            modal.classList.add('active');
            
            // è¨­å®šç‚ºç•¶å‰æœˆä»½
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('modalMonthPicker').value = currentMonth;
            
            // æ›´æ–°å ±å‘Š
            updateMonthlyReport();
        }

        // é—œé–‰æœˆåº¦çµç®—å ±å‘Š
        function closeMonthlyReport(event) {
            const modal = document.getElementById('monthlyReportModal');
            modal.classList.remove('active');
            
            // éŠ·æ¯€åœ–è¡¨ä»¥é‡‹æ”¾è³‡æº
            if (pieChartInstance) {
                pieChartInstance.destroy();
                pieChartInstance = null;
            }
        }

        // å¯†ç¢¼ç®¡ç†åŠŸèƒ½
        function addPassword() {
            const title = document.getElementById('passwordTitle').value;
            const username = document.getElementById('passwordUsername').value;
            const password = document.getElementById('passwordValue').value;
            const url = document.getElementById('passwordUrl').value;
            const note = document.getElementById('passwordNote').value;

            if (!title || !username || !password) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            appData.passwords.push({
                id: Date.now(),
                title,
                username,
                password,
                url,
                note,
                createdAt: new Date().toISOString()
            });

            saveData();
            renderPasswords();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('passwordTitle').value = '';
            document.getElementById('passwordUsername').value = '';
            document.getElementById('passwordValue').value = '';
            document.getElementById('passwordUrl').value = '';
            document.getElementById('passwordNote').value = '';
        }

        function deletePassword(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¯†ç¢¼å—ï¼Ÿ')) {
                appData.passwords = appData.passwords.filter(p => p.id !== id);
                saveData();
                renderPasswords();
            }
        }

        function togglePassword(id) {
            const element = document.getElementById(`pwd-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            if (element.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
                const pwd = appData.passwords.find(p => p.id === id);
                element.textContent = pwd.password;
                btn.textContent = 'éš±è—';
            } else {
                element.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                btn.textContent = 'é¡¯ç¤º';
            }
        }

        function renderPasswords() {
            const list = document.getElementById('passwordList');
            
            if (appData.passwords.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”‘</div><p>é‚„æ²’æœ‰ä»»ä½•å¯†ç¢¼è¨˜éŒ„</p></div>';
                return;
            }

            list.innerHTML = appData.passwords.map(p => `
                <div class="data-item">
                    <div class="data-item-header">
                        <div>
                            <div class="data-item-title">${p.title}</div>
                        </div>
                        <button class="btn-delete" onclick="deletePassword(${p.id})">åˆªé™¤</button>
                    </div>
                    <div class="data-item-info">
                        <div><span class="info-label">å¸³è™Ÿï¼š</span><span class="info-value">${p.username}</span></div>
                        <div class="password-field">
                            <span class="info-label">å¯†ç¢¼ï¼š</span>
                            <span class="info-value password-value" id="pwd-${p.id}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                            <span class="password-toggle" id="btn-${p.id}" onclick="togglePassword(${p.id})">é¡¯ç¤º</span>
                        </div>
                        ${p.url ? `<div style="grid-column: 1/-1;"><span class="info-label">ç¶²å€ï¼š</span><span class="info-value">${p.url}</span></div>` : ''}
                        ${p.note ? `<div style="grid-column: 1/-1;"><span class="info-label">å‚™è¨»ï¼š</span><span class="info-value">${p.note}</span></div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // è³‡ç”¢ç®¡ç†åŠŸèƒ½
        function addStock() {
            const symbol = document.getElementById('stockSymbol').value;
            const name = document.getElementById('stockName').value;
            const owner = document.getElementById('stockOwner').value;
            const shares = parseFloat(document.getElementById('stockShares').value) || 0;
            const currentPrice = parseFloat(document.getElementById('stockCurrentPrice').value);
            const date = document.getElementById('stockDate').value;
            const note = document.getElementById('stockNote').value;

            if (!symbol || !name || !owner || !currentPrice || !date) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            // å–å¾—è³‡ç”¢é¡å‹çš„ä¸­æ–‡åç¨±
            const assetTypeMap = {
                'stock': 'è‚¡ç¥¨',
                'fund': 'åŸºé‡‘',
                'crypto': 'åŠ å¯†è²¨å¹£',
                'bond': 'å‚µåˆ¸',
                'insurance': 'ä¿éšª',
                'real-estate': 'ä¸å‹•ç”¢',
                'other': 'å…¶ä»–'
            };

            appData.stocks.push({
                id: Date.now(),
                symbol,
                assetType: assetTypeMap[symbol] || symbol,
                name,
                owner,
                shares,
                currentPrice,
                date,
                note
            });

            saveData();
            renderStocks();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('stockSymbol').value = '';
            document.getElementById('stockName').value = '';
            document.getElementById('stockOwner').value = '';
            document.getElementById('stockShares').value = '';
            document.getElementById('stockCurrentPrice').value = '';
            document.getElementById('stockNote').value = '';
        }

        function deleteStock(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡ç”¢è¨˜éŒ„å—ï¼Ÿ')) {
                appData.stocks = appData.stocks.filter(s => s.id !== id);
                saveData();
                renderStocks();
            }
        }

        function renderStocks() {
            const list = document.getElementById('stockList');
            
            if (appData.stocks.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’</div><p>é‚„æ²’æœ‰ä»»ä½•è³‡ç”¢è¨˜éŒ„</p></div>';
                updateStockSummary();
                return;
            }

            list.innerHTML = appData.stocks.map(s => {
                const assetTypeLabel = s.assetType || s.symbol;
                const totalValue = s.shares ? (s.shares * s.currentPrice) : s.currentPrice;

                return `
                    <div class="data-item">
                        <div class="data-item-header">
                            <div>
                                <div style="color: var(--accent-primary); font-size: 12px; margin-bottom: 5px;">${assetTypeLabel}</div>
                                <div class="data-item-title">${s.name}</div>
                                <div class="data-item-amount" style="color: var(--accent-primary);">
                                    NT$ ${totalValue.toLocaleString('zh-TW')}
                                </div>
                            </div>
                            <button class="btn-delete" onclick="deleteStock(${s.id})">åˆªé™¤</button>
                        </div>
                        <div class="data-item-info">
                            <div><span class="info-label">æ‰€æœ‰äººï¼š</span><span class="info-value">${s.owner}</span></div>
                            ${s.shares ? `<div><span class="info-label">æŒæœ‰æ•¸é‡ï¼š</span><span class="info-value">${s.shares.toLocaleString()}</span></div>` : ''}
                            ${s.shares ? `<div><span class="info-label">å–®ä½åƒ¹å€¼ï¼š</span><span class="info-value">NT$ ${s.currentPrice.toLocaleString('zh-TW')}</span></div>` : ''}
                            <div><span class="info-label">è³‡ç”¢åƒ¹å€¼ï¼š</span><span class="info-value">NT$ ${totalValue.toLocaleString('zh-TW')}</span></div>
                            <div><span class="info-label">è³¼è²·æ—¥æœŸï¼š</span><span class="info-value">${s.date}</span></div>
                            ${s.note ? `<div style="grid-column: 1/-1;"><span class="info-label">å‚™è¨»ï¼š</span><span class="info-value">${s.note}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            updateStockSummary();
        }

        function updateStockSummary() {
            const totalValue = appData.stocks.reduce((sum, s) => {
                return sum + (s.shares ? (s.shares * s.currentPrice) : s.currentPrice);
            }, 0);

            document.getElementById('totalStockValue').textContent = `NT$ ${totalValue.toLocaleString('zh-TW')}`;
            document.getElementById('totalStockCost').textContent = `${appData.stocks.length} é …`;
            document.getElementById('totalStockProfit').style.display = 'none';
            
            // æ”¹è®Šç¬¬äºŒå€‹å¡ç‰‡çš„æ¨™ç±¤
            const costCard = document.getElementById('totalStockCost').parentElement.querySelector('.summary-label');
            costCard.textContent = 'è³‡ç”¢é …ç›®';
        }

        // åŒ¯å‡ºæ•¸æ“š
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `SecureVault_å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… æ•¸æ“šå·²æˆåŠŸåŒ¯å‡ºï¼');
        }

        // åŒ¯å…¥æ•¸æ“š
        function importData() {
            if (confirm('âš ï¸ åŒ¯å…¥æ•¸æ“šå°‡æœƒè¦†è“‹ç¾æœ‰æ•¸æ“šï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ\n\nå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ç¾æœ‰æ•¸æ“šã€‚')) {
                document.getElementById('importFileInput').click();
            }
        }

        // è™•ç†åŒ¯å…¥çš„æª”æ¡ˆ
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // é©—è­‰æ•¸æ“šçµæ§‹
                    if (!importedData.transactions || !importedData.passwords || !importedData.stocks) {
                        throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
                    }
                    
                    // è¦†è“‹ç¾æœ‰æ•¸æ“š
                    appData = importedData;
                    saveData();
                    renderAll();
                    
                    alert('âœ… æ•¸æ“šå·²æˆåŠŸåŒ¯å…¥ï¼');
                } catch (error) {
                    alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + error.message + '\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æª”æ¡ˆè¼¸å…¥
            event.target.value = '';
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰æ•¸æ“šï¼\n\nç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜å¸³ã€å¯†ç¢¼å’Œè³‡ç”¢æ•¸æ“šå—ï¼Ÿ\n\nå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚')) {
                if (confirm('ğŸ”´ æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                    appData = {
                        transactions: [],
                        passwords: [],
                        stocks: []
                    };
                    saveData();
                    renderAll();
                    alert('âœ… æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤');
                }
            }
        }

        // æ¸²æŸ“æ‰€æœ‰å…§å®¹
        function renderAll() {
            renderTransactions();
            renderPasswords();
            renderStocks();
            updateCategoryOptions(); // åˆå§‹åŒ–é¡åˆ¥é¸é …
        }

        // åˆå§‹åŒ–
        document.getElementById('transactionDate').valueAsDate = new Date();
        document.getElementById('stockDate').valueAsDate = new Date();

        // Enter éµç™»å…¥
        document.getElementById('masterPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // ESC éµé—œé–‰æ¨¡æ…‹è¦–çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('monthlyReportModal');
                if (modal && modal.classList.contains('active')) {
                    closeMonthlyReport();
                }
            }
        });

        // é˜²æ­¢åœ¨è¼¸å…¥æ•¸å­—æ™‚æ»¾å‹•é é¢
        document.addEventListener('wheel', function(e) {
            if (document.activeElement.type === 'number') {
                document.activeElement.blur();
            }
        });
    </script>

<script>
(function(){
  const KEY='sv_cold_start_done';
  if(sessionStorage.getItem(KEY)){
    document.getElementById('startup')?.remove();
    return;
  }
  window.addEventListener('load',()=>{
    setTimeout(()=>{
      const s=document.getElementById('startup');
      if(s){s.style.animation='svExit 280ms ease forwards';}
      sessionStorage.setItem(KEY,'1');
    },700);
  });
})();
</script>


<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>

</html>